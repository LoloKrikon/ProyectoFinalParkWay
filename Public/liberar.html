<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkWay - Dejar Sitio Libre</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
</head>

<body>
    <section class="view">
        <header class="app-header"
            style="margin-bottom: 0; padding: 1rem 2rem; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2);">
            <div class="header-left">
                <h2 class="mini-logo">ParkWay</h2>
            </div>
            <div class="header-right">
                <a href="plataformas.html" class="icon-btn" title="Volver"><i class="fa-solid fa-arrow-left"></i>
                    Volver</a>
            </div>
        </header>

        <div class="map-layout">
            <!-- Panel Lateral -->
            <div class="map-panel">
                <h2>üÖøÔ∏è Liberar Plaza</h2>
                <div class="map-input-group">
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Confirma tu ubicaci√≥n para avisar a otros conductores.
                    </p>
                    <button onclick="liberarPlaza()" class="primary-btn"
                        style="width: 100%; padding: 10px; background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fa-solid fa-check-circle"></i> Liberar mi sitio aqu√≠
                    </button>
                    <div id="statusMessage" style="margin-top: 10px; font-size: 0.9rem; text-align: center;"></div>
                </div>
            </div>

            <!-- Mapa -->
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </section>

    <!-- Leaflet Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

    <!-- L√≥gica del Mapa -->
    <script>
        const map = L.map('map').setView([40.4168, -3.7038], 15);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        let myMarker = null;

        // Custom My Location Icon
        const myIcon = L.divIcon({
            className: 'custom-car-icon',
            html: `
            <svg width="40" height="40" viewBox="0 0 24 24" style="filter: drop-shadow(0 0 10px #10b981);">
                <circle cx="12" cy="12" r="10" fill="#10b981" fill-opacity="0.3"/>
                <circle cx="12" cy="12" r="6" fill="#10b981"/>
                <circle cx="12" cy="12" r="2" fill="white"/>
            </svg>`,
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        // Geolocalizaci√≥n autom√°tica de inicio
        map.locate({ setView: true, maxZoom: 18 });

        function onLocationFound(e) {
            if (myMarker) map.removeLayer(myMarker);
            myMarker = L.marker(e.latlng, { icon: myIcon }).addTo(map)
                .bindPopup("Est√°s aqu√≠").openPopup();
        }

        function onLocationError(e) {
            console.warn(e.message);
            // Default center if fail
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // Simula la acci√≥n de liberar plaza (Feedback visual)
        function liberarPlaza() {
            if (!myMarker) {
                alert("Esperando se√±al GPS...");
                return;
            }
            const btn = document.querySelector('button[onclick="liberarPlaza()"]');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando...';

            setTimeout(() => {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> ¬°Sitio Liberado!';
                btn.style.background = '#059669';
                document.getElementById('statusMessage').textContent = "¬°Gracias! Tu sitio es visible para otros.";
                document.getElementById('statusMessage').style.color = "#10b981";
            }, 1500);
        }
    </script>
</body>

</html>